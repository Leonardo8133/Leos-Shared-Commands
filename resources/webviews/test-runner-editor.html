<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src {{cspSource}} 'unsafe-inline'; script-src 'nonce-{{nonce}}';" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Runner Configuration</title>
    <style>
      body {
        margin: 0;
        padding: 16px;
        font-family: var(--vscode-font-family);
        color: var(--vscode-foreground);
        background: var(--vscode-editor-background);
      }
      h1 {
        margin-top: 0;
        font-size: 18px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px 16px;
        margin-bottom: 16px;
      }
      label {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
        display: block;
      }
      input,
      select,
      textarea {
        width: 92%;
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid var(--vscode-input-border);
        background: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        font-size: 13px;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
        font-family: var(--vscode-editor-font-family, monospace);
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .row input[type='checkbox'] {
        width: auto;
      }
      .actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }
      button {
        border: none;
        border-radius: 4px;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
      }
      .primary {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }
      .primary:hover {
        background: var(--vscode-button-hoverBackground);
      }
      .secondary {
        background: transparent;
        border: 1px solid var(--vscode-button-border, var(--vscode-button-background));
        color: var(--vscode-button-foreground);
      }
      .danger {
        background: var(--vscode-errorForeground);
        color: white;
      }
      .help-text {
        font-size: 12px;
        color: var(--vscode-descriptionForeground);
        margin-top: 6px;
        line-height: 1.4;
      }
      .variable-name {
        color: var(--vscode-foreground, #ffffff);
        font-weight: 600;
      }
      .variable-path {
        color: var(--vscode-foreground, #ffffff);
        font-weight: 600;
      }
      .help-dropdown {
        width: 100%;
        margin-top: 16px;
        margin-bottom: 16px;
      }
      .help-toggle {
        width: 100%;
        padding: 10px 14px;
        background: var(--vscode-button-secondaryBackground);
        color: var(--vscode-button-secondaryForeground);
        border: 1px solid var(--vscode-button-border);
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
      }
      .help-toggle:hover {
        background: var(--vscode-button-secondaryHoverBackground);
      }
      .help-toggle::after {
        content: '▼';
        font-size: 10px;
        transition: transform 0.3s;
      }
      .help-toggle.expanded::after {
        transform: rotate(180deg);
      }
      .help-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background: var(--vscode-editor-background);
        border: 1px solid var(--vscode-widget-border);
        border-top: none;
        border-radius: 0 0 4px 4px;
      }
      .help-content.expanded {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
      }
      .help-inner {
        padding: 16px;
        font-size: 12px;
        line-height: 1.6;
        color: var(--vscode-foreground);
      }
      .help-section {
        margin-bottom: 20px;
      }
      .help-section h3 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 14px;
        color: var(--vscode-foreground);
        font-weight: 600;
      }
      .help-section h4 {
        margin-top: 16px;
        margin-bottom: 8px;
        font-size: 13px;
        color: var(--vscode-foreground);
        font-weight: 600;
      }
      .variable-item {
        margin-bottom: 12px;
        padding-left: 12px;
        border-left: 2px solid var(--vscode-textBlockQuote-border);
      }
      .variable-item code {
        background: var(--vscode-textCodeBlock-background);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: var(--vscode-editor-font-family, monospace);
      }
      .example-box {
        margin-top: 12px;
        padding: 12px;
        background: var(--vscode-textBlockQuote-background);
        border-left: 3px solid var(--vscode-textBlockQuote-border);
        border-radius: 4px;
      }
      .example-box code {
        display: block;
        margin: 4px 0;
        font-family: var(--vscode-editor-font-family, monospace);
      }
      .language-example {
        margin-top: 16px;
        padding: 12px;
        background: var(--vscode-editorWidget-background);
        border: 1px solid var(--vscode-widget-border);
        border-radius: 4px;
      }
      .language-example h5 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 12px;
        font-weight: 600;
        color: var(--vscode-foreground);
      }
      .variable-tip {
        margin-top: 8px;
        padding: 8px 12px;
        background: var(--vscode-textBlockQuote-background);
        border-left: 3px solid var(--vscode-textBlockQuote-border);
        border-radius: 4px;
        font-size: 10px;
      }
      .variable-extension {
        color: var(--vscode-foreground, #ffffff);
        font-weight: 600;
      }
      .variable-executable {
        color: #0078d4;
        font-weight: 600;
      }
      .help-text code {
        font-family: var(--vscode-editor-font-family, monospace);
        font-size: 11px;
        background: var(--vscode-textCodeBlock-background);
        padding: 2px 4px;
        border-radius: 2px;
      }
      .variable-hint {
        margin-top: 8px;
        padding: 8px;
        background: var(--vscode-textBlockQuote-background);
        border-left: 3px solid var(--vscode-textBlockQuote-border);
        border-radius: 4px;
        font-size: 12px;
        display: none;
      }
      .test-list {
        margin-top: 16px;
        padding: 12px;
        background: var(--vscode-editor-background);
        border: 1px solid var(--vscode-input-border);
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
      }
      .test-list-title {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
        font-weight: bold;
      }
      .test-list-content { font-size: 12px; color: var(--vscode-foreground); white-space: pre-wrap; word-wrap: break-word; }
      .test-list-empty {
        color: var(--vscode-descriptionForeground);
        font-style: italic;
      }
      .test-tree-content {
        font-size: 12px;
        color: var(--vscode-foreground);
      }
      .tree-node {
        margin: 2px 0;
        cursor: default;
      }
      .tree-folder, .tree-file, .tree-testcase {
        font-weight: 600;
        padding: 2px 0;
        user-select: none;
      }
      .tree-folder {
        color: var(--vscode-textLink-foreground, #0078d4);
      }
      .tree-file {
        color: var(--vscode-foreground);
      }
      .tree-testcase {
        color: var(--vscode-descriptionForeground);
      }
      .tree-test {
        padding-left: 20px;
        color: var(--vscode-foreground);
        padding: 2px 0 2px 20px;
      }
      .tree-icon {
        display: inline-block;
        width: 12px;
        margin-right: 4px;
        text-align: center;
      }
      .tree-children {
        margin-left: 16px;
        display: block;
      }
      .toggles-row {
        display: flex;
        gap: 24px;
        margin-bottom: 16px;
        padding: 12px;
        background: var(--vscode-editor-background);
        border: 1px solid var(--vscode-input-border);
        border-radius: 4px;
        flex-wrap: wrap;
      }
      .toggle-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        min-width: 150px;
      }
      .toggle-item label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0;
      }
      .toggle-switch {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      .toggle-switch input[type="checkbox"] {
        width: 40px;
        height: 20px;
        appearance: none;
        background: var(--vscode-input-background);
        border: 1px solid var(--vscode-input-border);
        border-radius: 10px;
        position: relative;
        cursor: pointer;
        transition: background 0.2s;
      }
      .toggle-switch input[type="checkbox"]:checked {
        background: var(--vscode-button-background);
      }
      .toggle-switch input[type="checkbox"]::before {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--vscode-foreground);
        top: 1px;
        left: 1px;
        transition: transform 0.2s;
      }
      .toggle-switch input[type="checkbox"]:checked::before {
        transform: translateX(20px);
      }
      .toggle-switch span {
        font-size: 13px;
        color: var(--vscode-foreground);
      }
    </style>
  </head>
  <body>
    <h1>Test Runner Configuration</h1>
    <div class="templates-row" style="display:flex;gap:12px;align-items:center;margin:8px 0 12px 0;flex-wrap:wrap;">
      <label style="margin:0;">Load template:</label>
      <select id="templateLanguage" style="width:auto;padding:4px 8px;">
        <option value="python">Python</option>
        <option value="javascript">JavaScript</option>
        <option value="typescript">TypeScript</option>
        <option value="java">Java</option>
        <option value="csharp">C#</option>
        <option value="go">Go</option>
        <option value="rust">Rust</option>
        <option value="php">PHP</option>
        <option value="ruby">Ruby</option>
        <option value="kotlin">Kotlin</option>
        <option value="swift">Swift</option>
        <option value="cpp">C++</option>
        <option value="scala">Scala</option>
        <option value="nextjs">Next.js</option>
        <option value="react">React</option>
      </select>
      <select id="templateName" style="width:auto;padding:4px 8px;"></select>
      <button id="loadTemplate" type="button" class="secondary">Load</button>
      <span class="help-text" style="margin:0;">Quickly prefill patterns and run command for common libraries.</span>
    </div>
    <div class="toggles-row">
      <div class="toggle-item">
        <label for="allowNonTest">Allow Non Test</label>
        <div class="toggle-switch">
          <input type="checkbox" id="allowNonTest" />
          <span id="allowNonTestLabel">ON</span>
        </div>
        <div class="help-text">Allow functions that doesn't have test in the name to be found</div>
      </div>
      <div class="toggle-item">
        <label for="autoFind">Auto Find</label>
        <div class="toggle-switch">
          <input type="checkbox" id="autoFind" checked />
          <span id="autoFindLabel">ON</span>
        </div>
        <div class="help-text">Automatically find tests when the extension load</div>
      </div>
      <div class="toggle-item">
        <label for="inlineButton">Inline Button</label>
        <div class="toggle-switch">
          <input type="checkbox" id="inlineButton" checked />
          <span id="inlineButtonLabel">ON</span>
        </div>
        <div class="help-text">Enable an RUN button right above the test name when opened</div>
      </div>
    </div>
    <div class="grid">
      <div>
        <label for="title">Title</label>
        <input id="title" type="text" placeholder="Run unit tests" />
      </div>
      <div>
        <label for="fileType">File type</label>
        <select id="fileType">
          <option value="javascript">JavaScript</option>
          <option value="typescript">TypeScript</option>
          <option value="python">Python</option>
          <option value="java">Java</option>
          <option value="csharp">C#</option>
          <option value="go">Go</option>
          <option value="rust">Rust</option>
          <option value="php">PHP</option>
          <option value="ruby">Ruby</option>
          <option value="kotlin">Kotlin</option>
          <option value="swift">Swift</option>
          <option value="cpp">C++</option>
          <option value="scala">Scala</option>
        </select>
      </div>
      <div>
        <label for="workingDirectory">Working directory</label>
        <input id="workingDirectory" type="text" placeholder="./" />
        <div class="help-text">Optional path where tests should run.</div>
      </div>
      <div>
        <label for="terminalName">Terminal name</label>
        <input id="terminalName" type="text" placeholder="Test Runner" />
      </div>
      <div>
        <label>Activated</label>
        <div class="row">
          <input id="activated" type="checkbox" />
          <span>Enable this configuration</span>
        </div>
      </div>
    </div>
    <div class="grid">
      <div style="position: relative;">
        <label for="filePattern">File name pattern</label>
        <textarea id="filePattern" placeholder="test_*&#10;*tests*"></textarea>
        <div class="help-text">One pattern per line. Use * as wildcard.<br/> Include file ext (.py, .js ...)
          <br/> Example: tests*/test_*.py, general_tests/*tests*.js
        </div>
        <div id="patternPreview" style="position: absolute; top: 0; right: -340px; width: 320px; border: 1px solid var(--vscode-widget-border); border-radius: 4px; padding: 12px; background: var(--vscode-editorWidget-background); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); max-height: 400px; overflow-y: auto; z-index: 1000; display: none;">
          <div style="font-weight: 600; margin-bottom: 8px; color: var(--vscode-foreground);">Pattern Preview</div>
          <div id="patternPreviewCount" style="margin-bottom: 8px; color: var(--vscode-descriptionForeground); font-size: 0.9em;"></div>
          <div id="patternPreviewFiles" style="font-family: var(--vscode-editor-font-family); font-size: 0.85em; color: var(--vscode-foreground);">
            <div style="color: var(--vscode-descriptionForeground); font-style: italic;">Type a pattern to see matching files...</div>
          </div>
        </div>
      </div>
      <div>
        <label for="testPattern">Test name pattern</label>
        <textarea id="testPattern" placeholder="test_*&#10;should_*"></textarea>
        <div class="help-text">Filters individual tests. Leave blank to include all.</div>
      </div>
      <div>
        <label for="ignoreList">Ignore list</label>
        <textarea id="ignoreList" placeholder="burlap&#10;*legacy*"></textarea>
        <div class="help-text">Patterns to ignore tests, files, or folders. Supports wildcards. One pattern per line. Matches test names and folder/file paths.</div>
      </div>
    </div>
    <div>
      <label for="command">Run test command</label>
      <input id="command" type="text" placeholder="python -m unittest $executable_test_path" />
      <div class="variable-tip" id="variableHint" style="display: none;"></div>
      
      <div class="help-dropdown">
        <button type="button" class="help-toggle" id="helpToggle">
          <span>Help: Variables & Test Discovery</span>
        </button>
        <div class="help-content" id="helpContent">
          <div class="help-inner">
            <div class="help-section">
              <h3>Available Variables</h3>
              
              <div class="variable-item">
                <strong class="variable-executable">$executable_test_path</strong>
                <p>Full executable path for running a specific test. Always uses dot notation (e.g., <code>src.main.tests.test_file.TestCase.test_method</code>). Includes module path, class name, and method name.</p>
                <p><strong>Trim parent option:</strong> Use <code>:trimparent=number</code> to remove parent segments from the beginning of the path.</p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                  <li><code>$executable_test_path</code> - Default: <code>src.main.tests.test_file.TestCase.test_method</code></li>
                  <li><code>$executable_test_path:trimparent=1</code> - Remove 1 parent: <code>main.tests.test_file.TestCase.test_methodd</code></li>
                  <li><code>$executable_test_path:trimparent=2</code> - Remove 2 parents: <code>tests.test_file.TestCase.test_method</code></li>
                </ul>
                <p><strong>Language-specific behavior:</strong></p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                  <li><strong>Python:</strong> Module path + class + method (relative to working directory). Example: <code>src.main.tests.test_file.TestCase.test_method</code></li>
                  <li><strong>JavaScript/TypeScript:</strong> File path + test name. Example: <code>src.tests.test_file.test_method</code></li>
                </ul>
              </div>

              <div class="variable-item">
                <strong class="variable-name">$test_name</strong>
                <p>Complete test identifier including class and method name.</p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                  <li><strong>Python:</strong> Includes class name: <code>ClassName.test_method</code> (e.g., <code>Testcase.test_simple_task</code>)</li>
                  <li><strong>JavaScript/TypeScript:</strong> Test function name only: <code>test_method</code> or <code>it_should_do_something</code></li>
                </ul>
              </div>

              <div class="variable-item">
                <strong class="variable-name">$test_testcase</strong>
                <p>Test case (class name) only, without the method name.</p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                  <li><strong>Python:</strong> Class name: <code>TestCase</code>, <code>TestUser</code></li>
                  <li><strong>JavaScript/TypeScript:</strong> Empty or describe block name (if available)</li>
                </ul>
              </div>

              <div class="variable-item">
                <strong class="variable-path">$test_file</strong>
                <p>Test file name without extension and path.</p>
                <p>Examples: <code>general_test</code>, <code>user_test</code>, <code>test_utils</code></p>
              </div>

              <div class="variable-item">
                <strong class="variable-path">$test_path</strong>
                <p>Test file path relative to workspace root, without extension.</p>
                <p><strong>Format options:</strong> Add <code>:dot</code>, <code>:slash</code>, or <code>:hyphen</code> to control separators. Default uses forward slashes.</p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                  <li><code>$test_path</code> - Default (forward slashes): <code>src/test/general_test</code></li>
                  <li><code>$test_path:dot</code> - Dots: <code>src.test.general_test</code></li>
                  <li><code>$test_path:slash</code> - Forward slashes: <code>src/test/general_test</code></li>
                  <li><code>$test_path:hyphen</code> - Hyphens: <code>src-test-general_test</code></li>
                </ul>
              </div>

              <div class="variable-item">
                <strong class="variable-extension">$test_extension</strong>
                <p>Test file extension including the dot.</p>
                <p>Examples: <code>.py</code>, <code>.js</code>, <code>.ts</code>, <code>.test.js</code></p>
              </div>

              <div class="example-box">
                <strong>Example:</strong> For file <code>src/test/general_test.py</code> with test method <code>test_simple_task</code> inside class <code>TestCase</code>
                <code>$executable_test_path = src.test.general_test.TestCase.test_simple_task</code>
                <code>$executable_test_path:trimparent=1 = test.general_test.TestCase.test_simple_task</code>
                <code>$test_name = TestCase.test_simple_task</code>
                <code>$test_testcase = TestCase</code>
                <code>$test_file = general_test</code>
                <code>$test_path = src/test/general_test</code>
                <code>$test_path:dot = src.test.general_test</code>
                <code>$test_extension = .py</code>
              </div>
            </div>

            <div class="help-section">
              <h3>Test Discovery Features</h3>
              
              <h4>File Name Pattern Matching</h4>
              <p>The <strong>File name pattern</strong> field uses flexible pattern matching to discover test files:</p>
              
              <ul style="margin: 8px 0; padding-left: 20px;">
                <li><strong>Wildcards:</strong> Use <code>*</code> to match any characters</li>
                <li><strong>Path patterns:</strong> Use <code>/</code> to match files in specific directories</li>
                <li><strong>Extension-agnostic:</strong> Patterns automatically ignore file extensions</li>
                <li><strong>Parent directory matching:</strong> Patterns like <code>tests*/*</code> match any folder starting with "tests"</li>
                <li><strong>Real-time preview:</strong> See matching file count and first 10 files as you type</li>
              </ul>

              <div class="language-example">
                <h5>Python Examples</h5>
                <p><strong>Pattern:</strong> <code>tests/test_*.py</code></p>
                <p><strong>Matches:</strong></p>
                <ul style="margin: 4px 0; padding-left: 20px;">
                  <li><code>tests/test_user.py</code></li>
                  <li><code>tests/test_auth.py</code></li>
                  <li><code>tests/test_utils.py</code></li>
                </ul>
                <p><strong>Pattern:</strong> <code>**/test_*.py</code></p>
                <p><strong>Matches:</strong> Any test file starting with "test_" in any subdirectory</p>
                <p><strong>Pattern:</strong> <code>tests*/test_*</code></p>
                <p><strong>Matches:</strong> Files in folders starting with "tests" (e.g., <code>tests_unit/test_*.py</code>, <code>tests_integration/test_*.py</code>)</p>
              </div>

              <div class="language-example">
                <h5>JavaScript/TypeScript Examples</h5>
                <p><strong>Pattern:</strong> <code>**/*.test.js</code></p>
                <p><strong>Matches:</strong></p>
                <ul style="margin: 4px 0; padding-left: 20px;">
                  <li><code>src/utils.test.js</code></li>
                  <li><code>src/components/Button.test.js</code></li>
                  <li><code>tests/integration/api.test.js</code></li>
                </ul>
                <p><strong>Pattern:</strong> <code>**/*.spec.ts</code></p>
                <p><strong>Matches:</strong> All TypeScript spec files in any directory</p>
                <p><strong>Pattern:</strong> <code>src/**/*test*</code></p>
                <p><strong>Matches:</strong> Any file containing "test" in the name within src directory</p>
              </div>

              <h4>Test Name Pattern</h4>
              <p>Use regular expressions to match test function/method names within files:</p>
              
              <div class="language-example">
                <h5>Python</h5>
                <p><strong>Pattern:</strong> <code>def test_</code></p>
                <p><strong>Matches:</strong> Functions starting with <code>def test_</code></p>
                <p><strong>Pattern:</strong> <code>def (test_|it_)</code></p>
                <p><strong>Matches:</strong> Functions starting with <code>def test_</code> or <code>def it_</code></p>
              </div>

              <div class="language-example">
                <h5>JavaScript/TypeScript</h5>
                <p><strong>Pattern:</strong> <code>(it|test|describe)\(</code></p>
                <p><strong>Matches:</strong> Jest/Mocha test functions: <code>it()</code>, <code>test()</code>, <code>describe()</code></p>
                <p><strong>Pattern:</strong> <code>^(it|test|describe)</code></p>
                <p><strong>Matches:</strong> Test functions at the start of a line</p>
              </div>

              <h4>Ignore List</h4>
              <p>Exclude specific tests, files, or folders from test discovery. Patterns match both test names and file/folder paths.</p>
              <ul style="margin: 8px 0; padding-left: 20px;">
                <li>One pattern per line</li>
                <li>Use <code>*</code> as wildcard for flexible matching</li>
                <li>Matches test names, file paths, folder paths, and individual folder names</li>
                <li>Automatically excludes common directories: <code>node_modules</code>, <code>out</code>, <code>__pycache__</code>, <code>.env</code>, etc.</li>
              </ul>
              <p><strong>Examples:</strong></p>
              <ul style="margin: 8px 0; padding-left: 20px;">
                <li><code>burlap</code> - Ignore all tests in folders named "burlap" or tests with "burlap" in the name</li>
                <li><code>*burlap*</code> - Ignore any path containing "burlap" anywhere</li>
                <li><code>tests/burlap/*</code> - Ignore all tests in the <code>tests/burlap/</code> folder</li>
                <li><code>test_old</code> - Ignore tests/files with "test_old" in the name</li>
                <li><code>legacy/*</code> - Ignore all tests in any "legacy" folder</li>
              </ul>

              <h4>Auto Find Feature</h4>
              <p>When <strong>Auto Find</strong> is enabled, tests are automatically discovered when the extension loads. When disabled, tests are only discovered when you manually click "Find Tests".</p>

              <h4>Pattern Preview Widget</h4>
              <p>As you type in the <strong>File name pattern</strong> field, a real-time preview widget appears showing:</p>
              <ul style="margin: 8px 0; padding-left: 20px;">
                <li>Total number of matching files</li>
                <li>First 10 matching file paths</li>
                <li>Updates automatically as you type (1 second delay)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button id="delete" type="button" class="danger">Delete</button>
      <button id="save" type="button" class="primary">Save</button>
    </div>
    <div class="test-list" id="testList" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <div class="test-list-title">Discovered Tests</div>
        <button id="toggleTreeView" type="button" class="secondary" style="font-size: 11px; padding: 4px 8px;">List View</button>
      </div>
      <div class="test-list-content" id="testListContent"></div>
      <div class="test-tree-content" id="testTreeContent" style="display: none;"></div>
    </div>
    <script nonce="{{nonce}}">
      const vscode = acquireVsCodeApi();
      const state = {
        id: null,
        isExisting: false
      };

      const elements = {
        title: document.getElementById('title'),
        fileType: document.getElementById('fileType'),
        workingDirectory: document.getElementById('workingDirectory'),
        terminalName: document.getElementById('terminalName'),
        activated: document.getElementById('activated'),
        filePattern: document.getElementById('filePattern'),
        testPattern: document.getElementById('testPattern'),
        ignoreList: document.getElementById('ignoreList'),
        command: document.getElementById('command'),
        deleteButton: document.getElementById('delete'),
        save: document.getElementById('save'),
        testList: document.getElementById('testList'),
        testListContent: document.getElementById('testListContent'),
        testTreeContent: document.getElementById('testTreeContent'),
        toggleTreeView: document.getElementById('toggleTreeView'),
        allowNonTest: document.getElementById('allowNonTest'),
        autoFind: document.getElementById('autoFind'),
        inlineButton: document.getElementById('inlineButton'),
        templateLanguage: document.getElementById('templateLanguage'),
        templateName: document.getElementById('templateName'),
        loadTemplate: document.getElementById('loadTemplate'),
        patternPreview: document.getElementById('patternPreview'),
        patternPreviewCount: document.getElementById('patternPreviewCount'),
        patternPreviewFiles: document.getElementById('patternPreviewFiles'),
        allowNonTestLabel: document.getElementById('allowNonTestLabel'),
        autoFindLabel: document.getElementById('autoFindLabel'),
        inlineButtonLabel: document.getElementById('inlineButtonLabel'),
        variableHint: document.getElementById('variableHint'),
        helpToggle: document.getElementById('helpToggle'),
        helpContent: document.getElementById('helpContent')
      };

      // Toggle switch handlers
      elements.allowNonTest.addEventListener('change', (e) => {
        elements.allowNonTestLabel.textContent = e.target.checked ? 'ON' : 'OFF';
      });
      elements.autoFind.addEventListener('change', (e) => {
        elements.autoFindLabel.textContent = e.target.checked ? 'ON' : 'OFF';
      });
      elements.inlineButton.addEventListener('change', (e) => {
        elements.inlineButtonLabel.textContent = e.target.checked ? 'ON' : 'OFF';
      });

      function populate(config) {
        state.id = config.id;
        state.isExisting = !!config.isExisting;
        elements.title.value = config.title || '';
        elements.fileType.value = config.fileType || 'javascript';
        elements.workingDirectory.value = config.workingDirectory || '';
        elements.terminalName.value = config.terminalName || '';
        elements.activated.checked = config.activated !== undefined ? config.activated : true;
        elements.filePattern.value = config.fileNamePattern || '';
        elements.testPattern.value = config.testNamePattern || '';
        elements.ignoreList.value = config.ignoreList || '';
        elements.command.value = config.runTestCommand || '';
        elements.deleteButton.disabled = !config.isExisting;
        
        // Set toggle switches (default to false if not specified)
        elements.allowNonTest.checked = config.allowNonTest !== undefined ? config.allowNonTest : false;
        elements.autoFind.checked = config.autoFind !== undefined ? config.autoFind : true;
        elements.inlineButton.checked = config.inlineButton !== undefined ? config.inlineButton : true;
        // Update labels
        elements.allowNonTestLabel.textContent = elements.allowNonTest.checked ? 'ON' : 'OFF';
        elements.autoFindLabel.textContent = elements.autoFind.checked ? 'ON' : 'OFF';
        elements.inlineButtonLabel.textContent = elements.inlineButton.checked ? 'ON' : 'OFF';
        
        // Check for variables in command
        checkVariablesInCommand(elements.command.value);
        
        // Don't trigger preview on load - only show when user focuses the field
      }

      function collectConfig() {
        return {
          id: state.id,
          title: elements.title.value,
          fileType: elements.fileType.value,
          workingDirectory: elements.workingDirectory.value,
          terminalName: elements.terminalName.value,
          activated: elements.activated.checked,
          fileNamePattern: elements.filePattern.value,
          testNamePattern: elements.testPattern.value,
          ignoreList: elements.ignoreList.value,
          runTestCommand: elements.command.value,
          allowNonTest: elements.allowNonTest.checked,
          autoFind: elements.autoFind.checked,
          inlineButton: elements.inlineButton.checked
        };
      }
      
      function checkVariablesInCommand(commandText) {
        const variables = ['test_name', 'test_testcase', 'test_file', 'test_path', 'test_extension', 'executable_test_path'];
        // Match variables with or without format options (e.g., $test_path:dot)
        const variablePattern = /\$(\w+)(?::\w+)?/g;
        const found = new Set();
        let match;
        while ((match = variablePattern.exec(commandText)) !== null) {
          const varName = match[1];
          if (variables.includes(varName)) {
            found.add(varName);
          }
        }
        
        if (found.size > 0) {
          let hintText = '<strong>💡 Tip:</strong> You are using ';
          const parts = Array.from(found).map(v => {
            const colorClass = v === 'test_name' || v === 'test_testcase' ? 'variable-name' : 
                              v === 'test_file' || v === 'test_path' ? 'variable-path' :
                              v === 'test_extension' ? 'variable-extension' : 'variable-executable';
            return `<span class="${colorClass}">$${v}</span>`;
          });
          hintText += parts.join(', ') + ' in your command.';
          elements.variableHint.innerHTML = hintText;
          elements.variableHint.style.display = 'block';
          elements.helpToggle.style.display = 'block';
        } else {
          elements.variableHint.style.display = 'none';
        }
      }
      
      // Add event listener for command input
      elements.command.addEventListener('input', (e) => {
        checkVariablesInCommand(e.target.value);
      });

      // Help dropdown toggle
      elements.helpToggle.addEventListener('click', () => {
        const isExpanded = elements.helpContent.classList.contains('expanded');
        if (isExpanded) {
          elements.helpContent.classList.remove('expanded');
          elements.helpToggle.classList.remove('expanded');
        } else {
          elements.helpContent.classList.add('expanded');
          elements.helpToggle.classList.add('expanded');
        }
      });

      // Pattern preview functionality
      let patternPreviewTimeout = null;
      let lastPreviewPattern = '';
      
      function updatePatternPreview(pattern, fileType, workingDirectory) {
        // Clear previous timeout
        if (patternPreviewTimeout) {
          clearTimeout(patternPreviewTimeout);
          patternPreviewTimeout = null;
        }

        const trimmedPattern = pattern.trim();
        
        // Make preview visible immediately when called
        if (trimmedPattern.length > 0 && fileType) {
          // Show loading state
          elements.patternPreview.style.display = 'block';
          elements.patternPreviewCount.textContent = 'Loading...';
          elements.patternPreviewFiles.innerHTML = '<div style="color: var(--vscode-descriptionForeground); font-style: italic;">Checking files...</div>';
        }

        // Debounce: wait 1 second after last change
        patternPreviewTimeout = setTimeout(() => {
          // Only request preview if pattern changed and is not empty
          if (trimmedPattern !== lastPreviewPattern) {
            lastPreviewPattern = trimmedPattern;
            
            if (trimmedPattern.length > 0 && fileType) {
              vscode.postMessage({
                type: 'previewPattern',
                pattern: trimmedPattern,
                fileType: fileType,
                workingDirectory: workingDirectory || ''
              });
            } else {
              // Clear preview if pattern is empty
              elements.patternPreview.style.display = 'none';
              elements.patternPreviewFiles.innerHTML = '<div style="color: var(--vscode-descriptionForeground); font-style: italic;">Type a pattern to see matching files...</div>';
            }
          } else if (trimmedPattern.length > 0 && fileType && elements.patternPreview.style.display === 'block') {
            // Pattern hasn't changed but preview is visible - request update anyway to refresh
            lastPreviewPattern = ''; // Reset to force update
            vscode.postMessage({
              type: 'previewPattern',
              pattern: trimmedPattern,
              fileType: fileType,
              workingDirectory: workingDirectory || ''
            });
          }
          patternPreviewTimeout = null;
        }, 1000);
      }

      function displayPatternPreview(count, files) {
        if (files === undefined) {
          // Error or no data
          elements.patternPreview.style.display = 'none';
          return;
        }

        elements.patternPreview.style.display = 'block';
        elements.patternPreviewCount.textContent = `${count} file(s) match the pattern`;
        
        if (files.length === 0) {
          elements.patternPreviewFiles.innerHTML = '<div style="color: var(--vscode-descriptionForeground); font-style: italic;">No files match this pattern</div>';
        } else {
          const filesList = files.slice(0, 10).map(file => {
            return `<div style="padding: 4px 0; border-bottom: 1px solid var(--vscode-input-border);">${escapeHtml(file)}</div>`;
          }).join('');
          
          const moreText = count > 10 ? `<div style="padding: 4px 0; color: var(--vscode-descriptionForeground); font-style: italic;">... and ${count - 10} more</div>` : '';
          
          elements.patternPreviewFiles.innerHTML = filesList + moreText;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Show/hide preview based on focus
      elements.filePattern.addEventListener('focus', () => {
        const pattern = elements.filePattern.value.trim();
        if (pattern.length > 0) {
          // Reset the last preview pattern to force update
          lastPreviewPattern = '';
          const currentConfig = collectConfig();
          // Clear any pending timeout and show preview immediately
          if (patternPreviewTimeout) {
            clearTimeout(patternPreviewTimeout);
            patternPreviewTimeout = null;
          }
          updatePatternPreview(
            pattern,
            currentConfig.fileType,
            currentConfig.workingDirectory
          );
        } else {
          // Show placeholder even if pattern is empty
          elements.patternPreview.style.display = 'block';
          elements.patternPreviewCount.textContent = '';
          elements.patternPreviewFiles.innerHTML = '<div style="color: var(--vscode-descriptionForeground); font-style: italic;">Type a pattern to see matching files...</div>';
        }
      });

      elements.filePattern.addEventListener('blur', () => {
        // Hide preview when field loses focus
        elements.patternPreview.style.display = 'none';
      });

      // Add event listener for file pattern changes
      elements.filePattern.addEventListener('input', () => {
        // Only update preview if field is focused
        if (document.activeElement === elements.filePattern) {
          const currentConfig = collectConfig();
          updatePatternPreview(
            elements.filePattern.value,
            currentConfig.fileType,
            currentConfig.workingDirectory
          );
        }
      });

      // Hide preview when other fields get focus
      const hidePreviewOnOtherFocus = () => {
        elements.patternPreview.style.display = 'none';
      };

      elements.title.addEventListener('focus', hidePreviewOnOtherFocus);
      elements.fileType.addEventListener('focus', hidePreviewOnOtherFocus);
      elements.workingDirectory.addEventListener('focus', hidePreviewOnOtherFocus);
      elements.terminalName.addEventListener('focus', hidePreviewOnOtherFocus);
      elements.testPattern.addEventListener('focus', hidePreviewOnOtherFocus);
      elements.ignoreList.addEventListener('focus', hidePreviewOnOtherFocus);
      elements.command.addEventListener('focus', hidePreviewOnOtherFocus);

      // Also trigger preview when file type or working directory changes (but only if pattern field is focused)
      elements.fileType.addEventListener('change', () => {
        if (document.activeElement === elements.filePattern && elements.filePattern.value.trim().length > 0) {
          const currentConfig = collectConfig();
          updatePatternPreview(
            elements.filePattern.value,
            currentConfig.fileType,
            currentConfig.workingDirectory
          );
        }
      });

      elements.workingDirectory.addEventListener('input', () => {
        if (document.activeElement === elements.filePattern && elements.filePattern.value.trim().length > 0) {
          const currentConfig = collectConfig();
          updatePatternPreview(
            elements.filePattern.value,
            currentConfig.fileType,
            currentConfig.workingDirectory
          );
        }
      });

      // Templates
      const templates = {
        python: [
          {
            name: 'unittest',
            data: {
              runTestCommand: 'python -m unittest $executable_test_path',
              fileNamePattern: 'test_*.py\n*_test.py',
              testNamePattern: 'test_*',
              workingDirectory: ''
            }
          },
          {
            name: 'pytest',
            data: {
              runTestCommand: 'python -m pytest "$test_path$test_extension" -k "$test_name" -q',
              fileNamePattern: 'test_*.py\n*_test.py',
              testNamePattern: 'test_*',
              workingDirectory: ''
            }
          },
          {
            name: 'django-test',
            data: {
              runTestCommand: 'python manage.py test $executable_test_path',
              fileNamePattern: 'test_*.py\n*_test.py',
              testNamePattern: 'test_*',
              workingDirectory: ''
            }
          }
        ],
        javascript: [
          {
            name: 'jest',
            data: {
              runTestCommand: 'npx jest -- $test_path$test_extension -t "$test_name"',
              fileNamePattern: '*.{test,spec}.js',
              testNamePattern: '*',
              workingDirectory: ''
            }
          },
          {
            name: 'mocha',
            data: {
              runTestCommand: 'npx mocha "$test_path$test_extension" -g "$test_name"',
              fileNamePattern: '*.{test,spec}.js',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        typescript: [
          {
            name: 'jest (ts-jest)',
            data: {
              runTestCommand: 'npx jest -- $test_path$test_extension -t "$test_name"',
              fileNamePattern: '*.{test,spec}.ts\n*.{test,spec}.tsx',
              testNamePattern: '*',
              workingDirectory: ''
            }
          },
          {
            name: 'vitest',
            data: {
              runTestCommand: 'npx vitest run --passWithNoTests -t "$test_name"',
              fileNamePattern: '*.{test,spec}.ts\n*.{test,spec}.tsx',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        ruby: [
          {
            name: 'rspec',
            data: {
              runTestCommand: 'bundle exec rspec "$test_path$test_extension" --example "$test_name"',
              fileNamePattern: '*_spec.rb',
              testNamePattern: '*',
              workingDirectory: ''
            }
          },
          {
            name: 'minitest',
            data: {
              runTestCommand: 'ruby "$test_path$test_extension" --name \'$test_name\'',
              fileNamePattern: 'test_*.rb',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        nextjs: [
          {
            name: 'jest (Next.js)',
            data: {
              runTestCommand: 'npx jest -- $test_path$test_extension -t "$test_name"',
              fileNamePattern: '*.{test,spec}.{js,ts,jsx,tsx}',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        react: [
          {
            name: 'jest (React)',
            data: {
              runTestCommand: 'npx jest -- $test_path$test_extension -t "$test_name"',
              fileNamePattern: '*.{test,spec}.{js,jsx,ts,tsx}',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        java: [
          {
            name: 'JUnit 5',
            data: {
              runTestCommand: 'mvn test -Dtest=$test_path.$test_name',
              fileNamePattern: '*Test.java\nTest*.java',
              testNamePattern: '*',
              workingDirectory: ''
            }
          },
          {
            name: 'JUnit 4',
            data: {
              runTestCommand: 'mvn test -Dtest=$test_path.$test_name',
              fileNamePattern: '*Test.java\nTest*.java',
              testNamePattern: '*',
              workingDirectory: ''
            }
          },
          {
            name: 'Gradle (JUnit)',
            data: {
              runTestCommand: 'gradle test --tests "$test_path.$test_name"',
              fileNamePattern: '*Test.java\nTest*.java',
              testNamePattern: '*',
              workingDirectory: ''
            }
          },
          {
            name: 'TestNG',
            data: {
              runTestCommand: 'mvn test -Dtest=$test_path',
              fileNamePattern: '*Test.java\nTest*.java',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        go: [
          {
            name: 'testing',
            data: {
              runTestCommand: 'go test -run "^$test_name$" ./$test_path',
              fileNamePattern: '*_test.go',
              testNamePattern: 'Test*',
              workingDirectory: ''
            }
          },
          {
            name: 'testify',
            data: {
              runTestCommand: 'go test -run "^$test_name$" ./$test_path',
              fileNamePattern: '*_test.go',
              testNamePattern: 'Test*',
              workingDirectory: ''
            }
          }
        ],
        rust: [
          {
            name: 'cargo test',
            data: {
              runTestCommand: 'cargo test $test_name --test $test_file',
              fileNamePattern: '*_test.rs\ntest_*.rs',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        php: [
          {
            name: 'PHPUnit',
            data: {
              runTestCommand: 'vendor/bin/phpunit --filter "$test_name" "$test_path$test_extension"',
              fileNamePattern: '*Test.php\nTest*.php',
              testNamePattern: '*',
              workingDirectory: ''
            }
          },
          {
            name: 'Pest',
            data: {
              runTestCommand: 'vendor/bin/pest --filter "$test_name" "$test_path$test_extension"',
              fileNamePattern: '*Test.php\n*.test.php',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        kotlin: [
          {
            name: 'JUnit 5',
            data: {
              runTestCommand: 'gradle test --tests "$test_path.$test_name"',
              fileNamePattern: '*Test.kt\nTest*.kt',
              testNamePattern: '*',
              workingDirectory: ''
            }
          },
          {
            name: 'Spek',
            data: {
              runTestCommand: 'gradle test --tests "$test_path"',
              fileNamePattern: '*Spec.kt\n*Specs.kt',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
        swift: [
          {
            name: 'XCTest',
            data: {
              runTestCommand: 'swift test --filter "$test_path.$test_name"',
              fileNamePattern: '*Tests.swift\n*Test.swift',
              testNamePattern: '*',
              workingDirectory: ''
            }
          }
        ],
      };

      function refreshTemplateNames() {
        if (!elements.templateLanguage || !elements.templateName) return;
        const lang = elements.templateLanguage.value;
        const list = templates[lang] || [];
        elements.templateName.innerHTML = '';
        for (const t of list) {
          const opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = t.name;
          elements.templateName.appendChild(opt);
        }
        if (list.length > 0) {
          elements.templateName.selectedIndex = 0;
        }
      }

      function initializeTemplateLoader() {
        if (!elements.templateLanguage || !elements.templateName || !elements.loadTemplate) return;

        elements.templateLanguage.addEventListener('change', refreshTemplateNames);
        refreshTemplateNames();

        elements.loadTemplate.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          try {
          const lang = elements.templateLanguage.value;
          const name = elements.templateName.value;
          if (!lang || !name) {
              vscode.postMessage({ type: 'showError', message: 'Select a language and a template.' });
            return;
          }
            const langTemplates = templates[lang] || [];
          const tpl = langTemplates.find(t => t.name === name);
            if (!tpl || !tpl.data) {
              vscode.postMessage({ type: 'showError', message: 'Template not found.' });
            return;
          }
          
          const d = tpl.data;
          const langMap = {
              python: 'python', javascript: 'javascript', typescript: 'typescript',
              java: 'java', csharp: 'csharp', go: 'go', rust: 'rust', php: 'php',
              ruby: 'ruby', kotlin: 'kotlin', swift: 'swift', cpp: 'cpp', scala: 'scala'
          };
            if (langMap[lang]) elements.fileType.value = langMap[lang];
            if (d.runTestCommand) elements.command.value = d.runTestCommand;
            if (d.fileNamePattern !== undefined) elements.filePattern.value = d.fileNamePattern;
            if (d.testNamePattern !== undefined) elements.testPattern.value = d.testNamePattern;
            if (d.workingDirectory !== undefined) elements.workingDirectory.value = d.workingDirectory;
          
          if (typeof checkVariablesInCommand === 'function') {
            checkVariablesInCommand(elements.command.value);
          }
            vscode.postMessage({ type: 'showInfo', message: `Loaded template: ${name}` });
        } catch (error) {
            const msg = error instanceof Error ? error.message : String(error);
            vscode.postMessage({ type: 'showError', message: `Template load failed: ${msg}` });
        }
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeTemplateLoader);
      } else {
        initializeTemplateLoader();
      }

      window.addEventListener('message', event => {
        const message = event.data;
        if (message.type === 'load') {
          populate({ ...message.config, isExisting: message.isExisting });
          // iconUris not needed without run buttons
          if (message.tests) {
            displayTests(message.tests);
          } else {
            hideTestList();
          }
        } else if (message.type === 'testsDiscovered') {
          displayTests(message.tests);
        } else if (message.type === 'patternPreview') {
          displayPatternPreview(message.count || 0, message.files || []);
        }
      });

      let treeViewMode = true; // Default to tree view
      let cachedTests = [];

      function displayTests(tests) {
        cachedTests = tests || [];
        if (!tests || tests.length === 0) {
          elements.testListContent.textContent = 'No tests found';
          elements.testListContent.className = 'test-list-content test-list-empty';
          elements.testTreeContent.innerHTML = '';
          elements.testList.style.display = 'block';
          return;
        }
        
        if (treeViewMode) {
          displayTestsAsTree(tests);
        } else {
          displayTestsAsList(tests);
        }
        elements.testList.style.display = 'block';
      }

      function displayTestsAsList(tests) {
        elements.testListContent.className = 'test-list-content';
        elements.testListContent.style.display = 'block';
        elements.testTreeContent.style.display = 'none';
        const text = tests.map((test, index) => {
          const relativePath = test.filePath || test.file || 'unknown';
          return `${index + 1}. ${test.label} (${relativePath}:${test.line + 1})`;
        }).join('\n');
        elements.testListContent.textContent = `${tests.length} test(s) found:\n\n${text}`;
      }

      function displayTestsAsTree(tests) {
        elements.testListContent.style.display = 'none';
        elements.testTreeContent.style.display = 'block';
        
        // Build tree structure: folder -> file -> testcase -> test
        const tree = {};
        
        tests.forEach(test => {
          const filePath = test.filePath || test.file || 'unknown';
          const pathParts = filePath.split(/[/\\]/);
          const fileName = pathParts.pop() || 'unknown';
          const folderPath = pathParts.join('/') || '.';
          
          // Extract test case from label (format: "TestClass.test_method" or "test_method")
          const labelParts = test.label.split('.');
          let testCase = '';
          let testMethod = test.label;
          if (labelParts.length > 1) {
            testCase = labelParts[0];
            testMethod = labelParts.slice(1).join('.');
          }
          
          // Build tree structure
          if (!tree[folderPath]) {
            tree[folderPath] = {};
          }
          if (!tree[folderPath][fileName]) {
            tree[folderPath][fileName] = {};
          }
          if (testCase && !tree[folderPath][fileName][testCase]) {
            tree[folderPath][fileName][testCase] = [];
          }
          let target;
          if (testCase) {
            if (!tree[folderPath][fileName][testCase]) {
              tree[folderPath][fileName][testCase] = [];
            }
            target = tree[folderPath][fileName][testCase];
          } else {
            if (!tree[folderPath][fileName]['__noTestCase__']) {
              tree[folderPath][fileName]['__noTestCase__'] = [];
            }
            target = tree[folderPath][fileName]['__noTestCase__'];
          }
          target.push({ method: testMethod, line: test.line + 1, label: test.label, filePath });
        });
        
        // Render tree
        let html = '<div style="margin-bottom: 8px; color: var(--vscode-descriptionForeground);">' + tests.length + ' test(s) found:</div>';
        
        const folderKeys = Object.keys(tree).sort();
        folderKeys.forEach(folderPath => {
          const folderName = folderPath === '.' ? 'Root' : folderPath.split('/').pop();
          html += `<div class="tree-node">
            <div class="tree-folder">
              <span class="tree-icon">📁</span>${folderName}
            </div>
            <div class="tree-children">`;
          
          const fileKeys = Object.keys(tree[folderPath]).sort();
          fileKeys.forEach(fileName => {
            html += `<div class="tree-node">
              <div class="tree-file">
                <span class="tree-icon">📄</span>${fileName}
              </div>
              <div class="tree-children">`;
            
            const testCaseKeys = Object.keys(tree[folderPath][fileName]).sort();
            testCaseKeys.forEach(testCase => {
              if (testCase === '__noTestCase__') {
                // Tests without a test case
                tree[folderPath][fileName][testCase].forEach(test => {
                  html += `<div class="tree-test">
                    <span class="tree-icon">•</span>${test.method} <span style="color: var(--vscode-descriptionForeground); font-size: 11px;">(${test.line})</span>
                  </div>`;
                });
              } else {
                html += `<div class="tree-node">
                  <div class="tree-testcase">
                    <span class="tree-icon">🧩</span>${testCase}
                  </div>
                  <div class="tree-children">`;
                tree[folderPath][fileName][testCase].forEach(test => {
                  // Display only method name, without test case prefix
                  const methodName = test.label.includes('.') ? test.label.split('.').slice(1).join('.') : test.method;
                  html += `<div class="tree-test">
                    <span class="tree-icon">✓</span>${methodName} <span style="color: var(--vscode-descriptionForeground); font-size: 11px;">(${test.line})</span>
                  </div>`;
                });
                html += `</div></div>`;
              }
            });
            
            html += `</div></div>`;
          });
          
          html += `</div></div>`;
        });
        
        elements.testTreeContent.innerHTML = html;
      }

      elements.toggleTreeView.addEventListener('click', () => {
        treeViewMode = !treeViewMode;
        elements.toggleTreeView.textContent = treeViewMode ? 'List View' : 'Tree View';
        if (cachedTests.length > 0) {
          displayTests(cachedTests);
      }
      });

      function hideTestList() {
        elements.testList.style.display = 'none';
      }

      elements.save.addEventListener('click', () => {
        vscode.postMessage({
          type: 'saveTestRunner',
          config: collectConfig()
        });
      });

      // Save then find tests (without discovery on plain save to avoid loops)
      // Removed Find Tests and Stop buttons from edit page

      elements.deleteButton.addEventListener('click', () => {
        if (!state.isExisting) {
          // For new configs, just close the editor
          vscode.postMessage({ type: 'cancel' });
          return;
        }

        // Request deletion confirmation from the extension
        if (state.id) {
          vscode.postMessage({ type: 'requestDeleteTestRunner', id: state.id });
        }
      });

      // Removed Run all from edit page

      vscode.postMessage({ type: 'ready' });
    </script>
  </body>
</html>
