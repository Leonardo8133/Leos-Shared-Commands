<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src {{cspSource}} 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'nonce-{{nonce}}'; font-src https://cdn.jsdelivr.net; img-src {{cspSource}} data:;" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuration</title>
    <style>
      body {
        margin: 0;
        font-family: var(--vscode-font-family);
        color: var(--vscode-foreground);
        background: var(--vscode-editor-background);
      }
      .container {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      h1 {
        margin: 0;
        font-size: 16px;
      }
      .section {
        border: 1px solid var(--vscode-panel-border);
        border-radius: 6px;
        padding: 12px;
        background: var(--vscode-editor-background);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .section-title {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
      }
      form {
        display: block;
      }
      .compact-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 6px 10px;
        align-items: center;
      }
      label {
        display: block;
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 4px;
      }
      input,
      textarea {
        width: 100%;
        padding: 5px 7px;
        border: 1px solid var(--vscode-input-border);
        border-radius: 4px;
        background: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        font-size: 12px;
      }
      textarea {
        min-height: 60px;
        resize: vertical;
        font-family: var(--vscode-editor-font-family, monospace);
      }
      .item-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 6px;
      }
      .card {
        border: 1px solid var(--vscode-panel-border);
        border-radius: 6px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        background: var(--vscode-editor-background);
      }
      .card-title {
        font-weight: 600;
        font-size: 13px;
      }
      .card-description {
        font-size: 12px;
        color: var(--vscode-descriptionForeground);
      }
      .card-actions {
        margin-top: 8px;
        display: flex;
        gap: 8px;
      }
      button {
        border: none;
        border-radius: 4px;
        padding: 5px 12px;
        font-size: 12px;
        cursor: pointer;
      }
      .primary-button {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }
      .primary-button:hover {
        background: var(--vscode-button-hoverBackground);
      }
      .secondary-button {
        background: transparent;
        color: var(--vscode-button-foreground);
        border: 1px solid var(--vscode-button-border, var(--vscode-button-background));
      }
      .danger-button {
        background: var(--vscode-errorForeground);
        color: var(--vscode-editor-background);
      }
      .json-editor {
        width: 100%;
        min-height: 320px;
        font-family: var(--vscode-editor-font-family, monospace);
        font-size: 12px;
        border-radius: 6px;
        padding: 10px;
        border: 1px solid var(--vscode-panel-border);
        background: var(--vscode-editor-background);
        color: var(--vscode-foreground);
      }
      .json-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 6px;
      }
      .compact-form button {
        justify-self: end;
      }
      .variables-table {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .variables-header {
        display: grid;
        grid-template-columns: 120px 150px 150px 200px 20px;
        gap: 6px;
        margin-bottom: 4px;
      }
      .variable-row {
        display: grid;
        grid-template-columns: 120px 150px 150px 200px 20px;
        gap: 6px;
        align-items: start;
      }
      .variable-row input,
      .variable-row select,
      .variable-row textarea {
        padding: 4px 6px;
        font-size: 11px;
        width: calc(100% - 20px);
        border: 1px solid var(--vscode-input-border);
        border-radius: 4px;
        background: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
      }
      .variable-row textarea {
        min-height: 60px;
        resize: vertical;
        font-family: var(--vscode-editor-font-family, monospace);
      }
      .variables-table .header {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--vscode-descriptionForeground);
        margin-bottom: 4px;
      }
      .variables-table .remove {
        background: transparent;
        border: none;
        color: var(--vscode-errorForeground);
        cursor: pointer;
        padding: 0;
        margin-top: 4px;
      }
      .variable-help {
        font-size: 10px;
        color: var(--vscode-descriptionForeground);
        margin-top: 2px;
        font-style: italic;
      }
      .variable-key-display {
        padding: 4px 6px;
        font-size: 11px;
        border: 1px solid var(--vscode-input-border);
        border-radius: 4px;
        background: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        font-family: var(--vscode-editor-font-family, monospace);
        cursor: pointer;
        user-select: all;
      }
      .variable-key-display:hover {
        background: var(--vscode-input-hoverBackground);
      }
      .variable-value-container {
        width: calc(100% - 20px);
      }
      .variable-value {
        width: calc(100% - 20px);
      }
      .variable-value textarea {
        width: calc(100% - 20px);
        min-height: 40px;
        resize: vertical;
        font-family: var(--vscode-editor-font-family, monospace);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Configuration</h1>
      <div class="section">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <h2 class="section-title">Global Variables</h2>
          <button id="add-variable" type="button" class="secondary-button">Add global variable</button>
        </div>
        <div class="variables-header" id="variables-header">
          <div class="header">Type</div>
          <div class="header">Label</div>
          <div class="header">Key</div>
          <div class="header">Value</div>
          <div></div>
        </div>
        <div class="variables-table" id="variables-container"></div>
      </div>
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Raw configuration (JSON)</h2>
          <small style="color: var(--vscode-descriptionForeground);">Use JSON to edit everything. The editor loads the current config automatically.</small>
        </div>
        <textarea id="json-editor" class="json-editor"></textarea>
        <div class="json-actions">
          <button type="button" id="save-json" class="primary-button">Save configuration</button>
        </div>
      </div>
    </div>
    <script nonce="{{nonce}}">
      const vscode = acquireVsCodeApi();
      let currentConfig = null;

      const elements = {
        variablesContainer: document.getElementById('variables-container'),
        addVariable: document.getElementById('add-variable'),
        jsonEditor: document.getElementById('json-editor'),
        saveJson: document.getElementById('save-json')
      };
      function slugify(value) {
        return value
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, '')
          .trim()
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-');
      }

      function generateUniqueKey(baseKey, existingKeys = []) {
        if (!baseKey) return 'var';
        
        // If base key is unique, use it
        if (!existingKeys.includes(baseKey)) {
          return baseKey;
        }
        
        // Find next available number
        let counter = 1;
        let candidateKey = `${baseKey}_${counter}`;
        while (existingKeys.includes(candidateKey)) {
          counter++;
          candidateKey = `${baseKey}_${counter}`;
        }
        
        return candidateKey;
      }

      function addVariableRow(variable = { value: '', label: '', type: 'fixed' }) {
        const row = document.createElement('div');
        row.className = 'variables-table variable-row';
        
        // Create the value field based on type
        const valueField = variable.type === 'options' 
          ? `<textarea class="variable-value" placeholder="production&#10;development&#10;staging" rows="3">${variable.value || ''}</textarea>`
          : `<input type="text" class="variable-value" placeholder="production" value="${variable.value || ''}" />`;
        
        // Generate key for display
        const baseKey = slugify(variable.label);
        const key = variable.key || generateUniqueKey(baseKey);
        
        row.innerHTML = `
          <select class="variable-type">
            <option value="fixed" ${variable.type === 'fixed' ? 'selected' : ''}>Fixed</option>
            <option value="options" ${variable.type === 'options' ? 'selected' : ''}>Options</option>
          </select>
          <input type="text" class="variable-label" placeholder="Environment" value="${variable.label || ''}" />
          <div class="variable-key-display" title="Click to copy key">${key}</div>
          <div class="variable-value-container">
            ${valueField}
            ${variable.type === 'options' ? '<div class="variable-help">Add one option per line</div>' : ''}
          </div>
          <button type="button" class="remove" title="Remove variable">×</button>
        `;
        
        // Add event listeners
        row.querySelector('.remove').addEventListener('click', () => {
          row.remove();
          saveVariables();
        });
        
        // Handle type change to switch between input and textarea
        const typeSelect = row.querySelector('.variable-type');
        const valueContainer = row.querySelector('.variable-value-container');
        const currentValue = row.querySelector('.variable-value').value;
        
        typeSelect.addEventListener('change', () => {
          const isOptions = typeSelect.value === 'options';
          const newValueField = isOptions 
            ? `<textarea class="variable-value" placeholder="production&#10;development&#10;staging" rows="3">${currentValue}</textarea>`
            : `<input type="text" class="variable-value" placeholder="production" value="${currentValue}" />`;
          
          valueContainer.innerHTML = newValueField + (isOptions ? '<div class="variable-help">Add one option per line</div>' : '');
          
          // Re-add event listeners
          valueContainer.querySelector('.variable-value').addEventListener('input', () => saveVariables());
          saveVariables();
        });
        
        // Update key when label changes
        const labelInput = row.querySelector('.variable-label');
        labelInput.addEventListener('input', () => {
          const baseKey = slugify(labelInput.value);
          // Get existing keys from other rows to avoid duplicates
          const otherRows = Array.from(elements.variablesContainer.querySelectorAll('.variable-row'))
            .filter(r => r !== row);
          const existingKeys = otherRows.map(r => {
            const keyDisplay = r.querySelector('.variable-key-display');
            return keyDisplay ? keyDisplay.textContent : '';
          });
          const newKey = generateUniqueKey(baseKey, existingKeys);
          const keyDisplay = row.querySelector('.variable-key-display');
          if (keyDisplay) {
            keyDisplay.textContent = newKey;
          }
          saveVariables();
        });
        
        ['input', 'change'].forEach(eventName => {
          row.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener(eventName, () => saveVariables());
          });
        });
        
        elements.variablesContainer.appendChild(row);
      }

      function renderVariables() {
        elements.variablesContainer.innerHTML = '';
        
        // Combine shared variables and shared lists into a single table
        const sharedVariables = currentConfig?.sharedVariables || [];
        const sharedLists = currentConfig?.sharedLists || [];
        
        // Convert shared variables to table format
        sharedVariables.forEach(variable => {
          addVariableRow({
            key: variable.key,
            label: variable.label || '',
            value: variable.value || '',
            type: 'fixed'
          });
        });
        
        // Convert shared lists to table format
        sharedLists.forEach(list => {
          addVariableRow({
            key: list.key,
            label: list.label || '',
            value: list.options.join('\n'),
            type: 'options'
          });
        });
      }

      function collectVariables() {
        const rows = Array.from(elements.variablesContainer.querySelectorAll('.variable-row'));
        
        // First pass: collect all existing keys to avoid recursion
        const existingKeys = [];
        const variables = rows
          .map((row, index) => {
            const valueField = row.querySelector('.variable-value');
            const value = valueField ? valueField.value.trim() : '';
            const label = row.querySelector('.variable-label').value.trim();
            const type = row.querySelector('.variable-type').value;
            
            // Generate unique key from slugified label
            const baseKey = label ? slugify(label) : 'var';
            const key = generateUniqueKey(baseKey, existingKeys);
            
            // Add this key to existing keys for next iteration
            existingKeys.push(key);
            
            return {
              key: key,
              value: value,
              label: label,
              type: type
            };
          });
          
        return variables;
      }

      function saveVariables() {
        const variables = collectVariables();
        
        // Separate fixed and options variables
        const sharedVariables = variables
          .filter(v => v.type === 'fixed' && v.value && v.label)
          .map(v => ({
            key: v.key,
            label: v.label,
            value: v.value
          }));
          
        const sharedLists = variables
          .filter(v => v.type === 'options' && v.value && v.label)
          .map(v => ({
            key: v.key,
            label: v.label,
            options: v.value.split('\n').filter(opt => opt.trim())
          }));
        
        // Update the config
        if (currentConfig) {
          currentConfig.sharedVariables = sharedVariables;
          currentConfig.sharedLists = sharedLists;
          loadJsonEditor();
        }
      }


      function loadJsonEditor() {
        if (!currentConfig) {
          elements.jsonEditor.value = '';
          return;
        }
        elements.jsonEditor.value = JSON.stringify(currentConfig, null, 2);
      }

      function handleSaveJson() {
        vscode.postMessage({ type: 'saveConfig', configJson: elements.jsonEditor.value });
      }

      function handleMessage(event) {
        const message = event.data;
        if (message.type === 'config') {
          currentConfig = message.config;
          renderVariables();
          loadJsonEditor();
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        elements.addVariable.addEventListener('click', () => {
          addVariableRow();
        });
        elements.saveJson.addEventListener('click', handleSaveJson);
        vscode.postMessage({ type: 'ready' });
      });

      window.addEventListener('message', handleMessage);
    </script>
  </body>
</html>
